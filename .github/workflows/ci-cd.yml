name: CI & CD
# NOTE: CI -> Continuous Integration
# NOTE: CD -> Continuous Delivery

on:
    pull_request:
        branches: [main]
        types: [opened, ready_for_review, reopened, synchronize]
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            reason:
                description: Reason of re-running this workflow
                required: false
                type: string

concurrency:
    group: ${{ github.workflow }}-${{ github.event.number || github.sha }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash

env:
    CI: true

permissions:
    contents: read
    id-token: write
    pages: write
    pull-requests: write

jobs:
    build_packages:
        name: packages
        uses: ./.github/workflows/build.yml
        secrets: inherit

    lint_biome:
        name: Lint
        uses: ./.github/workflows/biome.yml

    lint_inlang:
        name: Lint
        uses: ./.github/workflows/inlang.yml

    lint_markdownlint:
        name: Lint
        uses: ./.github/workflows/markdownlint.yml

    lint_prettier:
        name: Lint
        uses: ./.github/workflows/prettier.yml

    lint_size_limit:
        name: Lint
        uses: ./.github/workflows/size-limit.yml
        needs: [build_packages]
        if: github.event_name == 'pull_request'

    lint_typos:
        name: Lint
        uses: ./.github/workflows/typos.yml

    test_vitest:
        name: Test
        uses: ./.github/workflows/vitest.yml
        needs: [build_packages]
        secrets: inherit

    publish_chromatic:
        name: Publish
        uses: ./.github/workflows/chromatic.yml
        needs: [build_packages]
        secrets: inherit

    publish_typedoc:
        name: Publish
        uses: ./.github/workflows/typedoc.yml
        needs: [build_packages]
        if: |
            github.event_name == 'push' &&
            github.event.ref == 'refs/heads/main'

    release:
        name: Release
        uses: ./.github/workflows/changesets.yml
        needs:
            [
                lint_biome,
                lint_inlang,
                lint_markdownlint,
                lint_prettier,
                lint_size_limit,
                lint_typos,
                build_packages,
                publish_chromatic,
                publish_typedoc,
                test_vitest,
            ]
        if: |
            github.event_name == 'push' &&
            github.event.ref == 'refs/heads/main'
